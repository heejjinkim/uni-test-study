# 5. ëª©ê³¼ í…ŒìŠ¤íŠ¸ ì·¨ì•½ì„±

- ëŸ°ë˜íŒŒ
  - í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì½”ë“œ ì¡°ê°ì„ ì„œë¡œ ë¶„ë¦¬    
  - ë¶ˆë³€ ì˜ì¡´ì„±ì„ ì œì™¸í•œ ëª¨ë“  ì˜ì¡´ì„±ì— ëŒ€í•´ í…ŒìŠ¤íŠ¸ ëŒ€ì—­ ì‚¬ìš©í•˜ì—¬ ê²©ë¦¬
- ê³ ì „íŒŒ
  - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë¶„ë¦¬í•˜ì—¬ ë³‘ë ¬ë¡œ ì‹¤í–‰
  - í…ŒìŠ¤íŠ¸ ê°„ ê³µìœ í•˜ëŠ” ì˜ì¡´ì„±ë§Œ í…ŒìŠ¤íŠ¸ ëŒ€ì—­ ì‚¬ìš©

## í…ŒìŠ¤íŠ¸ ëŒ€ì—­(Test Double)

- ì •ì˜ : ëª¨ë“  ìœ í˜•ì˜ ë¹„ìš´ì˜ìš© ê°€ì§œ ì˜ì¡´ì„±
- ìš©ë„ : í…ŒìŠ¤íŠ¸ë¥¼ í¸ë¦¬í•˜ê²Œ í•˜ê¸° ìœ„í•¨
- ìœ í˜•
  - Mock
    - Mock : ê°€ì§œ ê°ì²´
    - Spy : ì§„ì§œ ê°ì²´, íŠ¹ì • ë©”ì†Œë“œë§Œ mockingí•˜ê³  ë‹¤ë¥¸ ë©”ì†Œë“œëŠ” ì •ìƒì ìœ¼ë¡œ ì‹¤ì œ ì‘ë™í•´ì•¼ í•  ë•Œ ì‚¬ìš©
  - Stub
    - Stub : í…ŒìŠ¤íŠ¸ ì¤‘ í˜¸ì¶œëœ ë©”ì†Œë“œì— ëŒ€í•´ ì´ë¯¸ ì •í•´ì§„ ê°’ì„ ë°˜í™˜
    - Dummy : ì‹¤ì œë¡œ ì‚¬ìš©ë˜ì§€ ì•Šê³  íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë§Œ ë˜ëŠ” ê°ì²´
    - Fake : ì‹¤ì œ ì‘ë™í•˜ëŠ” êµ¬í˜„ì„ ê°€ì§€ê³  ìˆì§€ë§Œ, í”„ë¡œë•ì…˜ì— ì í•©í•˜ì§€ ì•ŠëŠ” ë‹¨ì¶•ëœ ë°©ë²• ì‚¬ìš©í•œ ê°ì²´(ex. InmemoryDB)

### Mock

- ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” ìƒí˜¸ ì‘ìš©ì„ **ëª¨ë°© ë° ê²€ì‚¬**
  - SUTê°€ ìƒíƒœë¥¼ ë³€ê²½í•˜ê¸° ìœ„í•œ ì˜ì¡´ì„± í˜¸ì¶œ
- ëª…ë ¹ì˜ íŠ¹ì„±ì„ ë”, ë°˜í™˜ê°’ì´ ì—†ìŒ
- ì™¸ë¶€ì— ì‚¬ì´ë“œ ì´í™íŠ¸ë¥¼ ì´ˆë˜í•¨

**ìœ í˜• ë”°ë¥¸ ì°¨ì´**

- Mock : ëª© í”„ë ˆì„ì›Œí¬ì˜ ë„ì›€ì„ ë°›ì•„ ìƒì„±
- Spy : ìˆ˜ë™ìœ¼ë¡œ ì§ì ‘ ì‘ì„±

**ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ Mock Class**
ì´ í´ë˜ìŠ¤ëŠ” ê·¸ ìì²´ë¡œ mockì´ ì•„ë‹ˆê³  "ë„êµ¬"ì´ë‹¤.    
ì´ ë„êµ¬ë¥¼ í†µí•´ì„œ mockê³¼ stub ëª¨ë‘ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

### Stub

- ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” ìƒí˜¸ ì‘ìš© **ëª¨ë°©**
  - SUTê°€ ì…ë ¥ ë°ì´í„°ë¥¼ ì–»ê¸° ìœ„í•œ ì˜ì¡´ì„± í˜¸ì¶œ
- ì¡°íšŒì˜ íŠ¹ì„±ì„ ë”, ë°˜í™˜ê°’ì´ ìˆìŒ
- ì‚¬ì´ë“œ ì´í™íŠ¸ê°€ ì—†ìŒ
- SUTê°€ ì¶œë ¥ì„ ìƒì„±í•˜ë„ë¡, ì´ì— ëŒ€í•œ ì…ë ¥ì„ ì œê³µí•¨

**ìœ í˜•ì— ë”°ë¥¸ ì°¨ì´**

- Dummy : ë‹¨ìˆœí•˜ê³  í•˜ë“œì½”ë”©ëœ ê°’(Null, ê°€ì§œ ë¬¸ìì—´ ë“±)
  - SUTì˜ ë©”ì†Œë“œ ì‹œê·¸ë‹ˆì²˜ë¥¼ ë§Œì¡±ì‹œí‚¤ê¸° ìœ„í•´ ì‚¬ìš©
- Stub : ì™„ì „í•œ ì˜ì¡´ì„±(ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ë°˜í™˜ê°’ ëŒ€ì‘ ê°€ëŠ¥)
- Fake : Stubê³¼ ëª©ì ì€ ë™ì¼, ì•„ì§ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì˜ì¡´ì„± ëŒ€ì²´í•˜ê¸° ìœ„í•¨

### Mockê³¼ Stubì´ ë‚˜ëˆ„ì–´ì§„ ì´ìœ 

CQS(Command Query Separation) ì›ì¹™ì— ì˜í•´ì„œ.    
ëª…ë ¹ ì¡°íšŒ ë¶„ë¦¬ ì›ì¹™(CQS) : ëª¨ë“  ë©”ì†Œë“œëŠ” ëª…ë ¹ì´ê±°ë‚˜ ì¡°íšŒì—¬ì•¼ í•˜ë©°, ì´ ë‘˜ì„ í˜¼ìš©í•´ì„œëŠ” ì•ˆëœë‹¤.

- ëª…ë ¹
  - ì‚¬ì´ë“œ ì´í™íŠ¸ê°€ ë°œìƒ(ê°ì²´ ìƒíƒœ ë³€ê²½, íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ íŒŒì¼ ë³€ê²½ ë“±)
  - void ë°˜í™˜ ê°’
  - Mockì— í•´ë‹¹
- ì¡°íšŒ
  - ì‚¬ì´ë“œ ì´í™íŠ¸ê°€ ì—†ìŒ
  - ë°˜í™˜ê°’ ì¡´ì¬
  - ë©±ë“±ì„± ë³´ì¥
  - Stubì— í•´ë‹¹

### Stubìœ¼ë¡œ ìƒí˜¸ ì‘ìš©ì— ëŒ€í•œ ê²€ì¦ -> ì•ˆí‹°íŒ¨í„´

stubì€ ì‹¤ì œ ê²°ê³¼ë¬¼ì„ ì‚°ì¶œí•˜ê¸° ìœ„í•œ ìˆ˜ë‹¨ì´ë‹¤.    
ë¦¬íŒ©í† ë§ ë‚´ì„±ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ì„œ êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ì´ ì•„ë‹ˆë¼ ìµœì¢… ê²°ê³¼ë¥¼ ê²€ì¦í•´ì•¼ í•œë‹¤.    
ë”°ë¼ì„œ, stubì„ ì´ìš©í•  ë• ìƒí˜¸ ì‘ìš©ì— ëŒ€í•´ì„œ(ìµœì¢… ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ê·¸ ê³¼ì •) ê²€ì¦í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.    

```java
class Tests {

	@Test
	public void creating_a_report() {
		Database stub = Mockito.mock(Database.class);
		Mockito.when(stub.getNumberOfUsers()).thenReturn(10);
		Controller sut = new Controller(stub);

		Report report = sut.createReport();

		int expected = 10;
		assertEquals(expected, report.numberOfUsers);
		// ğŸ‘ stub ê°ì²´ì—ì„œ ë©”ì†Œë“œê°€ 1ë²ˆ í˜¸ì¶œë˜ëŠ” "ê³¼ì •"ì„ "ê²€ì¦"í•˜ê³  ìˆìŒ
		Mockito.verify(stub, Mockito.times(1)).getNumberOfUsers();
	}


	interface Database {
		int getNumberOfUsers();
	}

	class Controller {
		private final Database database;

		public Controller(Database database) {
			this.database = database;
		}

		public Report createReport() {
			int numberOfUsers = database.getNumberOfUsers();
			return new Report(numberOfUsers);
		}
	}

	class Report {
		public final int numberOfUsers;

		public Report(int numberOfUsers) {
			this.numberOfUsers = numberOfUsers;
		}
	}
}
```

### Mockê³¼ Stub ì—­í• ì„ ë™ì‹œì— í•˜ëŠ” í…ŒìŠ¤íŠ¸ ëŒ€ì—­

- stub ì—­í•  : ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” ìƒí˜¸ì‘ìš© ëª¨ë°©, ì™¸ë¶€ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì—¬ ê°€ì ¸ì˜´
- mock ì—­í•  : ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” ìƒí˜¸ì‘ìš© ê²€ì¦, ìˆ˜ëŸ‰ì„ ì¡°ì ˆí•˜ëŠ” ì‚¬ì´ë“œ ì´í™íŠ¸ì— ëŒ€í•´ ê²€ì¦

```java
class Tests {

	@Test
	public void purchase_fails_when_not_enough_inventory() {
		Store storeMock = Mockito.mock(Store.class);
		// stub ì—­í•  : ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” ìƒí˜¸ ì‘ìš© ëª¨ë°©
		Mockito.when(storeMock.hasEnoughInventory(Product.SHAMPOO, 5))
			.thenReturn(false);
		Customer sut = new Customer();

		boolean success = sut.purchase(storeMock, Product.SHAMPOO, 5);

		assertFalse(success);
		// mock ì—­í•  : ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” ìƒí˜¸ ì‘ìš©(side effect) ê²€ì¦
		Mockito.verify(storeMock, Mockito.never())
			.removeInventory(Product.SHAMPOO, 5);
	}

	class Store {
		private final Map<Product, Integer> inventory = new HashMap<>();

		public boolean hasEnoughInventory(Product product, int quantity) {
			return inventory.get(product) >= quantity;
		}

		public void removeInventory(Product product, int quantity) {
			inventory.put(product, inventory.get(product) - quantity);
		}
	}

	class Customer {
		public boolean purchase(Store store, Product product, int quantity) {
			if (!store.hasEnoughInventory(product, quantity)) {
				return false;
			}
			store.removeInventory(product, quantity);
			return true;
		}
	}

	enum Product {
		SHAMPOO;
	}
}
```

ì´ ê²½ìš° stubë³´ë‹¤ëŠ” mockì´ë¼ëŠ” ì‚¬ì‹¤ì´ ë” ì¤‘ìš”í•˜ê¸° ë•Œë¬¸ì—, ëŒ€ì²´ë¡œ Mockì´ë¼ê³  ë¶€ë¥¸ë‹¤.

**â“ ì™œ mockì´ë¼ëŠ” ê²ƒì´ stubì´ë¼ëŠ” ê²ƒë³´ë‹¤ ë” ì¤‘ìš”í• ê¹Œ**
Mockì€ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì˜ ë™ì‘ì„ ê²€ì¦í•˜ëŠ” ë° ë” ì§ì ‘ì ì¸ ì—­í• ì„ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.    
stubì€ ë‹¨ìˆœíˆ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ë§Œ, Mockì€ íŠ¹ì • ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€, í˜¸ì¶œë˜ì—ˆë‹¤ë©´ ëª‡ ë²ˆ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ ë“± ê°ì²´ ê°„ ìƒí˜¸ì‘ìš©ì„ "ê²€ì¦"í•  ìˆ˜ ìˆë‹¤.    
ê·¸ë˜ì„œ mockì´ í…ŒìŠ¤íŠ¸ì—ì„œ ë” ì˜ë¯¸ ìˆëŠ” ê²€ì¦ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ê³ , í…ŒìŠ¤íŠ¸ì˜ ëª©ì ì— ë¶€í•©í•˜ëŠ” ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì œê³µí•œë‹¤.    

## ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë™ì‘ vs êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­

ì œí’ˆ ì½”ë“œ ìœ í˜•

- ê³µê°œ API / ë¹„ê³µê°œ API
- ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë™ì‘ / êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­

- ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë™ì‘(ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­)
  - í´ë¼ì´ì–¸íŠ¸ê°€ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” "ì—°ì‚°" ë…¸ì¶œ
    - ì—°ì‚° : ê³„ì‚°ì„ ìˆ˜í–‰í•˜ê±°ë‚˜, ì‚¬ì´ë“œ ì´í™íŠ¸ë¥¼ ì´ˆë˜í•˜ê±°ë‚˜, ë‘˜ ë‹¤ í•˜ëŠ” ë©”ì†Œë“œ
  - í´ë¼ì´ì–¸íŠ¸ê°€ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” "ìƒíƒœ" ë…¸ì¶œ
    - ìƒíƒœ : ì‹œìŠ¤í…œì˜ í˜„ì¬ ìƒíƒœ
- êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ : ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ

> Best Practice

- ê³µê°œ APIì™€ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë™ì‘ ì´ ë™ì¼
- ë¹„ê³µê°œ APIì™€ êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ ì´ ë™ì¼

![Pasted image 20240821222556](https://github.com/user-attachments/assets/a3c809cd-7684-42b7-9743-e4bd736a745e)


> ğŸ‘ Bad Example

- `UserController.renameUser`ì˜ ìµœì¢… ëª©í‘œ : userì˜ ì´ë¦„ ì„¸íŒ…
  - normalizeNameì€ êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ì¸ë°, ê³µê°œ API => ë¶ˆë³€ì„± ìœ„ë°˜

```java
public class User {
	private String name;

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String normalizeName(String name) {
		String result = (name != null ? name : "").trim();
		if (result.length() > 50) {
			return result.substring(0, 50);
		}
		return result;
	}
}

public class UserController {
	public void renameUser(int userId, String newName) {
		User user = getUserFromDatabase(userId);

		String normalizedName = user.normalizeName(newName);
		user.setName(normalizedName);

		saveUserToDatabase(user);
	}
}
```

> ğŸ‘ Good Example

- `UserController.renameUser`ì˜ ìµœì¢… ëª©í‘œ : userì˜ ì´ë¦„ ì„¸íŒ…
  - setName => ë°ì´í„°ì™€ ì—°ì‚° ê²°í•©
  - normalizeNameì€ êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ì´ë¯€ë¡œ, ë¹„ê³µê°œ API => êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ ìˆ¨ê¸°ê¸°, ìº¡ìŠí™”

```java
public class User {
	private String name;

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = normalizeName(name);
	}

	private String normalizeName(String name) {
		String result = (name != null ? name : "").trim();
		if (result.length() > 50) {
			return result.substring(0, 50);
		}
		return result;
	}
}

public class UserController {
	public void renameUser(int userId, String newName) {
		User user = getUserFromDatabase(userId);
		user.setName(newName);
		saveUserToDatabase(user);
	}
}
```

### ì˜ ì„¤ê³„ëœ APIì™€ ìº¡ìŠí™”

êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ì„ ë…¸ì¶œí•˜ë©´ ë¶ˆë³€ì„± ìœ„ë°˜ì„ ê°€ì ¸ì˜¨ë‹¤.    
ìº¡ìŠí™” -> ë³µì¡ë„ ì œì–´ -> ì¥ê¸°ì ìœ¼ë¡œ ì§€ì† ê°€ëŠ¥ì„± ë†’ì„    
ì½”ë“œ ìº¡ìŠí™”ë¥¼ ì´ë£¨ê¸° ìœ„í•œ ë„êµ¬ë¡œì¨ 'êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ì„ ìˆ¨ê¸°ê³  ë°ì´í„°ì™€ ê¸°ëŠ¥ì„ ê²°í•©' í•´ì•¼ í•œë‹¤.    

- êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ ìˆ¨ê¸°ê¸° : í´ë¼ì´ì–¸íŠ¸ì—ê²Œ í´ë˜ìŠ¤ ë‚´ë¶€ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë‚´ë¶€ ì†ìƒ ìœ„í—˜ë„ ë‚®ì¶¤
- ë°ì´í„°ì™€ ì—°ì‚° ê²°í•© : í•´ë‹¹ ì—°ì‚°ì´ í´ë˜ìŠ¤ì˜ ë¶ˆë³€ì„±ì„ ìœ„ë°˜í•˜ì§€ ì•Šë„ë¡ í•¨
